@page "/counter"
@using global::Unstoppable.Blazor

@inject AsyncLocalStorage AsyncLocalStorage
<PageTitle>Counter</PageTitle>

<h1>Counter</h1>

<p role="status">Current count: @currentCount.Current</p>
<DataContainer HasData="@HasUpdated">
  <Template>
    <p role="status">
      Last updated @lastUpdated
    </p>
  </Template>
</DataContainer>

<button class="btn btn-primary" @onclick="IncrementCount">Click me</button>
<button class="btn btn-secondary" @onclick="ClearStore">Clear store</button>

@code {
  private CounterDetails currentCount = new();
  private DateTime lastUpdated = DateTime.MinValue;

  protected override async Task OnInitializedAsync()
  {
    CounterDetails? counter = await AsyncLocalStorage.GetAsync<CounterDetails>("counter");
    lastUpdated = await AsyncLocalStorage.GetAsync<DateTime>("lastUpdate");
    if (counter is null)
    {
      await AsyncLocalStorage.SetAsync("counter", currentCount);
      counter = await AsyncLocalStorage.GetAsync<CounterDetails>("counter");
    }

    currentCount = counter!;
  }

  private async Task IncrementCount()
  {
    currentCount.Current++;
    lastUpdated = DateTime.Now;
    await AsyncLocalStorage.SetAsync("counter", currentCount);
    await AsyncLocalStorage.SetAsync("lastUpdate", lastUpdated);
  }

  private async Task ClearStore()
  {
    await AsyncLocalStorage.ClearStoreAsync();
    currentCount = new();
    lastUpdated = DateTime.MinValue;
  }

  private bool HasUpdated => lastUpdated != DateTime.MinValue;
}